var socket=io.connect();var userRoomsList;var currentRoom;var myUsername;function escapeHtml(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function toClassString(a){return a.replace(/\s/g,"-")}function toClassStringr(a){return a.replace(/-/g," ")}function addMessage(c,i,g){var k=toClassString(i);if(currentRoom!=i){var h=userRoomsList.map(function(l){return l.roomName}).indexOf(i);userRoomsList[h].numNewMsgs++;if($("#"+k+"-badge").is(":hidden")){$("#"+k+"-badge").parent().addClass("tab-badge-notification-bg");$("#"+k+"-badge").show()}$("#"+k+"-badge").text(userRoomsList[h].numNewMsgs)}var d=new Date();var f=d.getHours();var e=d.getMinutes();var a=d.getSeconds();var b="am";if(f>11){b="pm";if(f>12){f=f%12}}if(e<10){e="0"+e}if(a<10){a="0"+a}d=f+":"+e+":"+a+" "+b;$("div#chat-panel div#room-"+k+" div.chat-entries").append('<div class="message bg-primary"><span class="msgUser">'+g+'</span> : <span class="msgContent">'+escapeHtml(c)+'</span><span class="message-timestamp">'+d+"</span></div>");var j=$("div#chat-panel div#room-"+k+" div.chat-entries");if(Math.abs((j[0].scrollHeight-j.scrollTop()-j.outerHeight())<200)){j.animate({scrollTop:j[0].scrollHeight},200)}else{$("#more-msgs").filter(":hidden").fadeIn(1000).delay(3000).fadeOut(3000)}}function sentMessage(){if($("#message-input").val()!=""){var b=$("#message-input").val();var a={messageBody:b,messageRoom:currentRoom};socket.emit("sendMessage",a);addMessage(b,currentRoom,"Me");$("#message-input").val("")}}socket.on("disconnect",function(a){console.log("reconnect");socket.socket.reconnect()});socket.on("kickClient",function(a){window.location.href=a.url});socket.on("sendMessageResponse",function(a){addMessage(a.message,a.roomName,a.username)});socket.on("numConnected",function(a){$("#num-connected").html("Users online: "+a.numConnected)});socket.on("initRoomsList",function(a,b){userRoomsList=[{roomName:a[0],numNewMsgs:0}];$("#public-rooms-title").text("Public Rooms:");populatePublicRoomsList({publicRoomsList:b})});socket.on("saveUsername",function(a){myUsername=a.clientUsername});socket.on("loadUsersList",function(c){var d=toClassString(c.roomName);$("#usersList-"+d).empty();$("#usersList-"+d).append('<div class="my-username"><span class="glyphicon glyphicon-user"></span>'+myUsername+" (You)</div>");for(var a=0;a<c.usernamesList.length;a++){if(c.usernamesList[a]!=myUsername){$("#usersList-"+d).append('<div class="username" draggable="true"><span class="glyphicon glyphicon-user"></span>'+c.usernamesList[a]+"</div>");var b=$("div.username:contains("+c.usernamesList[a]+")");b.on({dragstart:function(f){f.dataTransfer.setData("username",$(this).text());$(this).css("opacity","0.4")},dragend:function(f){$(this).css("opacity","1")}})}}});socket.on("roomInvite",function(a){window.alert("User "+a.inviter+" invites you to "+a.roomName);socket.emit("acceptInvitation",a.roomName)});socket.on("createRoomResponse",function(a){if(a.created){userRoomsList.push({roomName:a.roomName,numNewMsgs:0});var b=toClassString(a.roomName);$("div#chat-panel").append('<div id="room-'+b+'" class="tab-pane"><div class="chat-entries"></div></div>');$("div#username-container").append('<div id="usersList-'+b+'" class="usersList"></div>');$("ul#tab").append('<li class="span roomTab"><a href="#room-'+b+'" data-toggle="tab"><span id = "'+b+'-badge" class="badge tab-badge"></span>'+a.roomName+'<span class="glyphicon glyphicon-remove"></span></a></li>');$("ul#tab li:contains("+a.roomName+") a").click(function(d){d.preventDefault();$(this).tab("show");$("div.usersList").hide();$("div#usersList-"+b).show();currentRoom=a.roomName;var c=userRoomsList.map(function(f){return f.roomName}).indexOf(currentRoom);userRoomsList[c].numNewMsgs=0;$("#"+b+"-badge").hide();$("#"+b+"-badge").parent().removeClass("tab-badge-notification-bg");$("#public-rooms-container").hide()});$("ul#tab li:contains("+a.roomName+") span.glyphicon-remove").click(function(){$(this).parent().parent().remove();$("div#room-"+b).remove();$("div#userlist-"+b).remove();socket.emit("leaveRoom",a.roomName);$('ul#tab a:contains("Lobby")').click();currentRoom="Lobby";var c=userRoomsList.map(function(d){return d.roomName}).indexOf(a.roomName);userRoomsList.splice(c,1)});$("#tab-container .roomTab:contains("+a.roomName+") a").on({dragleave:function(c){$(this).removeClass("over");c.preventDefault()},dragenter:function(c){$(this).addClass("over");c.preventDefault()},dragover:function(c){$(this).addClass("over");c.preventDefault()},drop:function(c){$(this).removeClass("over");c.preventDefault();socket.emit("inviteUser",{username:c.dataTransfer.getData("username"),roomName:a.roomName})}});$("#room-modal-close-button").click();socket.emit("joinRoom",a.roomName);$("ul#tab li:contains("+a.roomName+") a").click()}else{if(a.errorCode==1){window.alert("Illegal room name! Room name can only contain alphanumeric characters, spaces, and underscores!")}else{if(a.errorCode==2){window.alert("A room with that name already exists! Please choose another name!")}else{if(a.errorCode==3){window.alert("Room name 'Lobby' is reserved, please choose another name!")}else{window.alert("Unknown error! Room cannot be created!")}}}}});function populatePublicRoomsList(b){$("#public-rooms-list").empty();for(var a=0;a<b.publicRoomsList.length;a++){$("#public-rooms-list").append('<div class="public-room-entry" id='+toClassString(b.publicRoomsList[a])+'-public-room><span class="glyphicon glyphicon-home public-room-icon"></span>'+b.publicRoomsList[a]+"</div>");var c=$("div.public-room-entry:contains("+b.publicRoomsList[a]+")");c.on({click:function(g){var d=this.id;var f=d.indexOf("-public-room");var d=d.slice(0,f);d=toClassStringr(d);var f=userRoomsList.map(function(h){return h.roomName}).indexOf(d);if(f==-1){socket.emit("joinPublicRoom",d)}else{$('a[href="#room-'+toClassString(d)+'"]').click()}}})}}socket.on("populatePublicRooms",function(a){populatePublicRoomsList(a)});$(function(){jQuery.event.props.push("dataTransfer");currentRoom="Lobby";$("#message-input").keypress(function(b){var a=(b.keyCode?b.keyCode:b.which);if(a=="13"){$("#submit").click()}});$('ul#tab a:contains("Lobby")').click(function(b){b.preventDefault();$(this).tab("show");$("div.usersList").hide();$("div#usersList-Lobby").show();currentRoom="Lobby";var a=userRoomsList.map(function(c){return c.roomName}).indexOf(currentRoom);userRoomsList[a].numNewMsgs=0;$("#"+currentRoom+"-badge").hide();$("#"+currentRoom+"-badge").parent().removeClass("tab-badge-notification-bg");$("#public-rooms-container").show()});$('ul#tab a:contains("Lobby")').tab("show");$("ul#tab li span.glyphicon-remove").click(function(){$(this).parent().parent().remove();var a=$(this).parent().text();$("div#room-"+toClassString(a)).remove();socket.emit("leaveRoom",a)});$("#add-room").click(function(){$("#create-room-modal").modal("show")});$("#create-room-buttom").click(function(){var a=$("input#create-room-modal-input").val();var b=$("input#public-room-checkbox").prop("checked")?1:0;if(a){socket.emit("createRoom",{roomName:a,isPublic:b});$("input#create-room-modal-input").val("");$("input#public-room-checkbox").prop("checked",false)}});$("#create-room-modal-input").keypress(function(b){var a=(b.keyCode?b.keyCode:b.which);if(a=="13"){$("#create-room-buttom").click()}});$("#submit").click(function(){sentMessage()})});