var socket=io.connect("",{query:"username="+username});var userRoomsList;var currentRoom;var myUsername;function escapeHtml(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function toClassString(a){return a.replace(/\s/g,"-")}function toClassStringr(a){return a.replace(/-/g," ")}function addMessage(c,k,h,j){var m=toClassString(k);if(currentRoom!=k){var i=userRoomsList.map(function(o){return o.roomName}).indexOf(k);userRoomsList[i].numNewMsgs++;if($("#"+m+"-badge").is(":hidden")){$("#"+m+"-badge").parent().addClass("tab-badge-notification-bg");$("#"+m+"-badge").show()}$("#"+m+"-badge").text(userRoomsList[i].numNewMsgs)}var d=new Date();var f=d.getHours();var e=d.getMinutes();var a=d.getSeconds();var b="am";if(f>11){b="pm";if(f>12){f=f%12}}else{if(f==0){f=12}}if(e<10){e="0"+e}if(a<10){a="0"+a}d=f+":"+e+":"+a+" "+b;var g=j?"bg-primary":"bg-info";g=h=="@UWBot"?"bg-success":g;var n=h=="@UWBot"?c:escapeHtml(c);$("div#chat-panel div#room-"+m+" div.chat-entries").append('<div class="message '+g+'"><span class="msg-user">'+h+'</span> : <span class="msg-content">'+n+'</span><span class="message-timestamp">'+d+"</span></div>");var l=$("div#chat-panel div#room-"+m+" div.chat-entries");if(Math.abs((l[0].scrollHeight-l.scrollTop()-l.outerHeight())<200)){l.animate({scrollTop:l[0].scrollHeight},200)}else{$("#more-msgs").filter(":hidden").fadeIn(1000).delay(3000).fadeOut(3000)}emojify.run()}function sentMessage(){if($("#message-input").val()!=""){var b=$("#message-input").val();var a={messageBody:b,messageRoom:currentRoom};socket.emit("sendMessage",a);addMessage(b,currentRoom,"Me",false);$("#message-input").val("")}}function populatePublicRoomsList(b){$("#public-rooms-list").empty();for(var a=0;a<b.publicRoomsList.length;a++){$("#public-rooms-list").append('<div class="public-room-entry" id='+toClassString(b.publicRoomsList[a])+'-public-room><span class="glyphicon glyphicon-home public-room-icon"></span>'+b.publicRoomsList[a]+"</div>");var c=$("div.public-room-entry:contains("+b.publicRoomsList[a]+")");c.on({click:function(g){var d=this.id;var f=d.indexOf("-public-room");var d=d.slice(0,f);d=toClassStringr(d);var f=userRoomsList.map(function(h){return h.roomName}).indexOf(d);if(f==-1){socket.emit("joinRoom",{roomName:d,hasAccepted:true})}else{$('a[href="#room-'+toClassString(d)+'"]').click()}}})}}socket.on("disconnect",function(a){socket.socket.reconnect()});socket.on("kickClient",function(a){window.location.href=a.url});socket.on("sendMessageResponse",function(a){addMessage(a.message,a.roomName,a.username,true)});socket.on("numConnected",function(a){if(a.roomName=="Lobby"){$("#num-connected-Lobby").html("Users online: "+a.numConnected)}else{$("#num-connected-"+toClassString(a.roomName)).html("Users in room: "+a.numConnected)}});socket.on("initRoomsList",function(a,b){userRoomsList=[{roomName:a[0],numNewMsgs:0}];$("#public-rooms-title").text("Public Rooms:");populatePublicRoomsList({publicRoomsList:b})});socket.on("saveUsername",function(a){myUsername=a.clientUsername});socket.on("loadUsersList",function(b){var c=toClassString(b.roomName);$("#usersList-"+c).empty();if(b.roomName=="Lobby"){$("#all-users-list").empty();if(b.usernamesList.length==1){$("#all-users-list").append("(No one's online...)")}}$("#usersList-"+c).append('<div class="my-username"><span class="glyphicon glyphicon-user"></span>'+myUsername+" (You)</div>");for(var a=0;a<b.usernamesList.length;a++){if(b.usernamesList[a]!=myUsername){$("#usersList-"+c).append('<div class="username"><span class="glyphicon glyphicon-user"></span>'+b.usernamesList[a]+"</div>");if(b.roomName=="Lobby"){$("#all-users-list").append('<div class="username"><span class="glyphicon glyphicon-user"></span>'+b.usernamesList[a]+"</div>");$("#all-users-list div.username:contains("+b.usernamesList[a]+")").click(function(d){socket.emit("inviteUser",{username:$(this).text(),roomName:currentRoom})})}}}if(typeof b.allUsernamesList!=="undefined"){if(b.allUsernamesList.length==1){$("#create-room-modal-invite-user-container").empty();$("#create-room-modal-invite-user-container").append("(No one's online...)")}else{$("#create-room-modal-invite-user-container").empty();for(var a=0;a<b.allUsernamesList.length;a++){if(b.allUsernamesList[a]!=myUsername){$("#create-room-modal-invite-user-container").append('<div class="create-room-modal-username" data-username="'+b.allUsernamesList[a]+'" data-selected="false"> <span class="glyphicon glyphicon-user"></span>'+b.allUsernamesList[a]+"</div>")}}$("div.create-room-modal-username").click(function(){if($(this).data("selected")=="true"){$(this).removeClass("create-room-modal-username-selected");$(this).data("selected","false")}else{$(this).addClass("create-room-modal-username-selected");$(this).data("selected","true")}})}}});socket.on("roomInvite",function(a){$("#invitation-modal>div>div>div.modal-body").text("User "+a.inviter+" has invited you to "+a.roomName);$("#invitation-modal-accept-button").data("roomName",a.roomName);$("#invitation-modal").modal("show")});socket.on("joinRoomResponse",function(a){if(a.created){userRoomsList.push({roomName:a.roomName,numNewMsgs:0});var b=toClassString(a.roomName);$("div#chat-panel").append('<div id="room-'+b+'" class="tab-pane"><div class="chat-entries"></div></div>');$("div#num-connected-container").append('<div id="num-connected-'+b+'" class="num-connected"></div>');$("div#username-container").append('<div id="usersList-'+b+'" class="usersList"></div>');$("ul#tab").append('<li class="span roomTab"><a href="#room-'+b+'" data-toggle="tab"><span id = "'+b+'-badge" class="badge tab-badge"></span>'+a.roomName+'<span class="glyphicon glyphicon-remove"></span></a></li>');$("ul#tab li:contains("+a.roomName+") a").click(function(d){d.preventDefault();$(this).tab("show");$("div.usersList").hide();$("div#usersList-"+b).show();currentRoom=a.roomName;var c=userRoomsList.map(function(f){return f.roomName}).indexOf(currentRoom);userRoomsList[c].numNewMsgs=0;$("#"+b+"-badge").hide();$("#"+b+"-badge").parent().removeClass("tab-badge-notification-bg");$("#public-rooms-container").hide();$("div.num-connected").hide();$("div#num-connected-"+b).show();$("div#all-users-list-container").show()});$("ul#tab li:contains("+a.roomName+") span.glyphicon-remove").click(function(){$(this).parent().parent().remove();$("div#room-"+b).remove();$("div#userlist-"+b).remove();socket.emit("leaveRoom",a.roomName);$('ul#tab a:contains("Lobby")').click();currentRoom="Lobby";var c=userRoomsList.map(function(d){return d.roomName}).indexOf(a.roomName);userRoomsList.splice(c,1)});$("ul#tab li:contains("+a.roomName+") a").click()}else{if(a.errorCode==1){window.alert("Illegal room name! Room name can only contain alphanumeric characters, spaces, and underscores!")}else{if(a.errorCode==2){window.alert("A room with that name already exists! Please choose another name!")}else{if(a.errorCode==3){window.alert("Room name 'Lobby' is reserved, please choose another name!")}else{window.alert("Unknown error! Room cannot be created!")}}}}});socket.on("populatePublicRooms",function(a){populatePublicRoomsList(a)});socket.on("failedInvitation",function(a){$("#failed-invitation-modal>div>div>div.modal-body").text("Cannot invite user: "+a.invitee+", they seem to already be in room: "+a.roomName);$("#failed-invitation-modal").modal("show")});socket.on("deleteTabs",function(){userRoomsList=[{roomName:"Lobby",numNewMsgs:0}];$('ul#tab a:contains("Lobby")').click();currentRoom="Lobby";$("ul#tab>li+li+li").remove();$("div#chat-panel>div+div+div+div").remove()});$(function(){currentRoom="Lobby";$("#message-input").keypress(function(b){var a=(b.keyCode?b.keyCode:b.which);if(a=="13"){$("#submit").click()}});$('ul#tab a:contains("Lobby")').click(function(b){b.preventDefault();$(this).tab("show");$("div.usersList").hide();$("div#usersList-Lobby").show();currentRoom="Lobby";var a=userRoomsList.map(function(c){return c.roomName}).indexOf(currentRoom);userRoomsList[a].numNewMsgs=0;$("#"+currentRoom+"-badge").hide();$("#"+currentRoom+"-badge").parent().removeClass("tab-badge-notification-bg");$("#public-rooms-container").show();$("div.num-connected").hide();$("div#num-connected-Lobby").show();$("div#all-users-list-container").hide()});$('ul#tab a:contains("Lobby")').tab("show");$("ul#tab li span.glyphicon-remove").click(function(){$(this).parent().parent().remove();var a=$(this).parent().text();$("div#room-"+toClassString(a)).remove();socket.emit("leaveRoom",a)});$("#add-room").click(function(){$("#create-room-modal").modal("show")});$("#create-room-button").click(function(){var b=$("input#create-room-modal-input").val();var d=$("input#public-room-checkbox").prop("checked")?true:false;if(b){socket.emit("createRoom",{roomName:b,isPublic:d});$("input#create-room-modal-input").val("");$("input#public-room-checkbox").prop("checked",false);$("#room-modal-close-button").click();var a=new Array();$.each($("#create-room-modal-invite-user-container>div"),function(){if($(this).data("selected")=="true"){a.push($(this).data("username"));$(this).removeClass("create-room-modal-username-selected");$(this).data("selected","false")}});for(var c=0;c<a.length;c++){socket.emit("inviteUser",{username:a[c],roomName:b})}}});$("#create-room-modal-input").keypress(function(b){var a=(b.keyCode?b.keyCode:b.which);if(a=="13"){$("#create-room-button").click()}});$("#invitation-modal-accept-button").click(function(){var a=$("#invitation-modal-accept-button").data("roomName");socket.emit("joinRoom",{roomName:a,hasAccepted:true});$("#invitation-modal").modal("hide")});$("#invitation-modal-decline-button").click(function(){var a=$("#invitation-modal-accept-button").data("roomName");socket.emit("joinRoom",{roomName:a,hasAccepted:false})});$("#submit").click(function(){sentMessage()});emojify.setConfig({emojify_tag_type:"span.msg-content",img_dir:"/img/emoji/"})});